<div class="login-page">
  <div class="login-card">
    <div class="login-card__image">
      <div class="login-card__image-overlay">
        <p class="login-card__badge">CurriculoPro IA</p>
        <h2 class="login-card__headline">
          Seu currículo profissional,
          <span>impulsionado por IA.</span>
        </h2>
        <p class="login-card__subtitle">
          Analise, otimize e melhore seu currículo com inteligência artificial em poucos minutos.
        </p>
      </div>
    </div>

    <div class="login-card__content">
      <div class="login-card__inner">
        <p class="login-card__brand">CurriculoPro IA</p>
        
        <!-- Tela de verificação de email -->
        <div *ngIf="showVerificationStep">
          <h1 class="login-card__title">Verifique seu email</h1>
          <p class="login-card__description">
            Enviamos um código de verificação de 6 dígitos para <strong>{{ registeredEmail }}</strong>
          </p>

          <form (ngSubmit)="verifyEmail()" class="login-form">
            <div class="login-form__field">
              <label class="login-form__label">Código de verificação</label>
              <input
                type="text"
                [(ngModel)]="verificationCode"
                name="verificationCode"
                (input)="onVerificationCodeInput($event)"
                required
                maxlength="6"
                class="login-form__input"
                placeholder="000000"
                pattern="[0-9]{6}"
              />
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="verifyLoading || !verificationCode || verificationCode.length !== 6">
              <span *ngIf="!verifyLoading">Verificar</span>
              <span *ngIf="verifyLoading">Verificando...</span>
            </button>
          </form>

          <p class="login-card__switch">
            Não recebeu o código?
            <button
              type="button"
              class="login-card__switch-button"
              (click)="resendVerificationCode()"
              [disabled]="resendLoading"
            >
              {{ resendLoading ? 'Reenviando...' : 'Reenviar código' }}
            </button>
          </p>

          <p class="login-card__switch" style="margin-top: 1rem;">
            <button
              type="button"
              class="login-card__switch-button"
              (click)="toggleMode(); showVerificationStep = false;"
            >
              Voltar ao login
            </button>
          </p>
        </div>

        <!-- Tela de recuperação de senha -->
        <div *ngIf="showForgotPassword && !showResetPassword">
          <h1 class="login-card__title">Recuperar Senha</h1>
          <p class="login-card__description">
            Digite seu email e enviaremos um link para redefinir sua senha.
          </p>

          <form (ngSubmit)="requestPasswordReset()" class="login-form">
            <div class="login-form__field">
              <label class="login-form__label">Email</label>
              <input
                type="email"
                [(ngModel)]="forgotPasswordEmail"
                name="forgotPasswordEmail"
                required
                class="login-form__input"
                placeholder="seu@email.com"
              />
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <div *ngIf="forgotPasswordSuccess" class="login-form__success">
              {{ forgotPasswordSuccess }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="forgotPasswordLoading">
              <span *ngIf="!forgotPasswordLoading">Enviar link de recuperação</span>
              <span *ngIf="forgotPasswordLoading">Enviando...</span>
            </button>
          </form>

          <p class="login-card__switch">
            <button
              type="button"
              class="login-card__switch-button"
              (click)="showForgotPassword = false; error = ''; forgotPasswordSuccess = '';"
            >
              Voltar ao login
            </button>
          </p>
        </div>

        <!-- Tela de redefinir senha -->
        <div *ngIf="showResetPassword">
          <h1 class="login-card__title">Redefinir Senha</h1>
          <p class="login-card__description">
            Digite sua nova senha.
          </p>

          <form (ngSubmit)="resetPassword()" class="login-form">
            <div class="login-form__field">
              <label class="login-form__label">Nova Senha</label>
              <div class="login-form__password-wrapper">
                <input
                  [type]="showNewPassword ? 'text' : 'password'"
                  [(ngModel)]="newPassword"
                  name="newPassword"
                  required
                  class="login-form__input login-form__input--password"
                  placeholder="Mínimo de 6 caracteres"
                  minlength="6"
                />
                <button
                  type="button"
                  class="login-form__password-toggle"
                  (click)="showNewPassword = !showNewPassword"
                  tabindex="-1"
                >
                  <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
              </div>
            </div>

            <div class="login-form__field">
              <label class="login-form__label">Confirmar Nova Senha</label>
              <div class="login-form__password-wrapper">
                <input
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  [(ngModel)]="confirmPassword"
                  name="confirmPassword"
                  required
                  class="login-form__input login-form__input--password"
                  placeholder="Digite a senha novamente"
                  minlength="6"
                />
                <button
                  type="button"
                  class="login-form__password-toggle"
                  (click)="showConfirmPassword = !showConfirmPassword"
                  tabindex="-1"
                >
                  <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
              </div>
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="resetPasswordLoading">
              <span *ngIf="!resetPasswordLoading">Redefinir Senha</span>
              <span *ngIf="resetPasswordLoading">Redefinindo...</span>
            </button>
          </form>

          <p class="login-card__switch">
            <button
              type="button"
              class="login-card__switch-button"
              (click)="showResetPassword = false; showForgotPassword = false; error = '';"
            >
              Voltar ao login
            </button>
          </p>
        </div>

        <!-- Tela de login/cadastro -->
        <div *ngIf="!showVerificationStep && !showForgotPassword && !showResetPassword && !showLoginCodeStep">
          <h1 class="login-card__title">
            {{ isLogin ? 'Bem-vindo de volta' : 'Crie sua conta' }}
          </h1>
          <p class="login-card__description">
            {{
              isLogin
                ? 'Entre para analisar e otimizar seus currículos com IA.'
                : 'Leva menos de 1 minuto para começar a melhorar seu currículo com inteligência artificial.'
            }}
          </p>

          <!-- Seleção de método de login (apenas para login) -->
          <div *ngIf="isLogin" class="login-form__method-selector">
            <button
              type="button"
              class="login-form__method-btn"
              [class.login-form__method-btn--active]="loginMethod === 'password'"
              (click)="loginMethod = 'password'"
            >
              <mat-icon>lock</mat-icon>
              <span>Senha</span>
            </button>
            <button
              type="button"
              class="login-form__method-btn"
              [class.login-form__method-btn--active]="loginMethod === 'code'"
              (click)="loginMethod = 'code'; showLoginCodeStep = true; error = ''; success = '';"
            >
              <mat-icon>email</mat-icon>
              <span>Código</span>
            </button>
          </div>

          <form (ngSubmit)="submit()" class="login-form" *ngIf="!isLogin || loginMethod === 'password'">
            <div *ngIf="!isLogin" class="login-form__field">
              <label class="login-form__label">Nome completo</label>
              <input
                type="text"
                [(ngModel)]="nome"
                name="nome"
                required
                class="login-form__input"
                placeholder="Como está no seu currículo"
              />
            </div>

            <div class="login-form__field">
              <label class="login-form__label">Email</label>
              <input
                type="email"
                [(ngModel)]="email"
                name="email"
                required
                class="login-form__input"
                placeholder="seu@email.com"
              />
            </div>

            <div class="login-form__field" *ngIf="!isLogin || loginMethod === 'password'">
              <div class="login-form__password-header">
                <label class="login-form__label">Senha</label>
                <button
                  type="button"
                  class="login-form__forgot-password"
                  (click)="showForgotPassword = true; error = ''; success = '';"
                  *ngIf="isLogin"
                >
                  Esqueci minha senha
                </button>
              </div>
              <div class="login-form__password-wrapper">
                <input
                  [type]="showPassword ? 'text' : 'password'"
                  [(ngModel)]="senha"
                  name="senha"
                  required
                  class="login-form__input login-form__input--password"
                  placeholder="Mínimo de 6 caracteres"
                  minlength="6"
                />
                <button
                  type="button"
                  class="login-form__password-toggle"
                  (click)="togglePasswordVisibility()"
                  [attr.aria-label]="showPassword ? 'Ocultar senha' : 'Mostrar senha'"
                  tabindex="-1"
                >
                  <mat-icon>{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
              </div>
            </div>

            <!-- Checkbox de proteção de dados (apenas no cadastro) -->
            <div *ngIf="!isLogin" class="login-form__privacy">
              <label class="login-form__privacy-label">
                <input
                  type="checkbox"
                  [(ngModel)]="acceptPrivacyPolicy"
                  name="acceptPrivacyPolicy"
                  required
                  class="login-form__privacy-checkbox"
                />
                <span class="login-form__privacy-text">
                  Concordo com a 
                  <a href="/politica-de-privacidade" target="_blank" class="login-form__privacy-link">Política de Privacidade</a>
                  e 
                  <a href="/termos-de-uso" target="_blank" class="login-form__privacy-link">Termos de Uso</a>
                </span>
              </label>
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <div *ngIf="success" class="login-form__success">
              {{ success }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="loading || (!isLogin && !acceptPrivacyPolicy)">
              <span *ngIf="!loading">{{ isLogin ? 'Entrar' : 'Criar conta' }}</span>
              <span *ngIf="loading">{{ isLogin ? 'Entrando...' : 'Criando conta...' }}</span>
            </button>
          </form>

          <p class="login-card__switch">
            {{ isLogin ? 'Ainda não tem conta?' : 'Já tem conta?' }}
            <button
              type="button"
              class="login-card__switch-button"
              (click)="toggleMode()"
            >
              {{ isLogin ? 'Criar conta grátis' : 'Fazer login' }}
            </button>
          </p>
        </div>

        <!-- Tela de login com código -->
        <div *ngIf="showLoginCodeStep && !showForgotPassword && !showResetPassword">
          <h1 class="login-card__title">Login com Código</h1>
          <p class="login-card__description">
            Digite seu email para receber um código de login.
          </p>

          <!-- Formulário para solicitar código -->
          <form (ngSubmit)="requestLoginCode()" class="login-form" *ngIf="!codeSent">
            <div class="login-form__field">
              <label class="login-form__label">Email</label>
              <input
                type="email"
                [(ngModel)]="loginCodeEmail"
                name="loginCodeEmail"
                required
                class="login-form__input"
                placeholder="seu@email.com"
              />
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <div *ngIf="success" class="login-form__success">
              {{ success }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="requestCodeLoading">
              <span *ngIf="!requestCodeLoading">Enviar código</span>
              <span *ngIf="requestCodeLoading">Enviando...</span>
            </button>
          </form>

          <!-- Formulário para inserir código -->
          <form (ngSubmit)="verifyLoginCode()" class="login-form" *ngIf="codeSent">
            <div class="login-form__field">
              <label class="login-form__label">Código de Login</label>
              <div class="login-form__code-container">
                <input
                  #codeInput0
                  type="text"
                  [value]="loginCodeDigits[0] || ''"
                  name="codeDigit0"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 0)"
                  (keydown)="onLoginCodeKeyDown($event, 0)"
                  (paste)="onLoginCodePaste($event)"
                />
                <input
                  #codeInput1
                  type="text"
                  [value]="loginCodeDigits[1] || ''"
                  name="codeDigit1"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 1)"
                  (keydown)="onLoginCodeKeyDown($event, 1)"
                  (paste)="onLoginCodePaste($event)"
                />
                <input
                  #codeInput2
                  type="text"
                  [value]="loginCodeDigits[2] || ''"
                  name="codeDigit2"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 2)"
                  (keydown)="onLoginCodeKeyDown($event, 2)"
                  (paste)="onLoginCodePaste($event)"
                />
                <input
                  #codeInput3
                  type="text"
                  [value]="loginCodeDigits[3] || ''"
                  name="codeDigit3"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 3)"
                  (keydown)="onLoginCodeKeyDown($event, 3)"
                  (paste)="onLoginCodePaste($event)"
                />
                <input
                  #codeInput4
                  type="text"
                  [value]="loginCodeDigits[4] || ''"
                  name="codeDigit4"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 4)"
                  (keydown)="onLoginCodeKeyDown($event, 4)"
                  (paste)="onLoginCodePaste($event)"
                />
                <input
                  #codeInput5
                  type="text"
                  [value]="loginCodeDigits[5] || ''"
                  name="codeDigit5"
                  required
                  class="login-form__code-digit"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  autocomplete="off"
                  (input)="onLoginCodeInput($event, 5)"
                  (keydown)="onLoginCodeKeyDown($event, 5)"
                  (paste)="onLoginCodePaste($event)"
                />
              </div>
            </div>

            <div *ngIf="error" class="login-form__error">
              {{ error }}
            </div>

            <div *ngIf="success" class="login-form__success">
              {{ success }}
            </div>

            <button type="submit" class="login-form__submit" [disabled]="loginCodeLoading">
              <span *ngIf="!loginCodeLoading">Entrar</span>
              <span *ngIf="loginCodeLoading">Verificando...</span>
            </button>

            <button
              type="button"
              class="login-form__resend-code"
              (click)="codeSent = false; loginCode = ''; loginCodeDigits = ['', '', '', '', '', '']; loginCodeEmail = ''; success = ''; error = '';"
              [disabled]="requestCodeLoading"
            >
              Reenviar código
            </button>
          </form>

          <p class="login-card__switch">
            <button
              type="button"
              class="login-card__switch-button"
              (click)="showLoginCodeStep = false; loginCode = ''; loginCodeDigits = ['', '', '', '', '', '']; loginCodeEmail = ''; error = ''; success = ''; loginMethod = 'password'; codeSent = false;"
            >
              Voltar ao login
            </button>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

